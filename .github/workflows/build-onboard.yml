name: gcp build & deploy np-onboarding

#on:
#  push:
#   branches: [ actions_gcp ]

on:
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: Build with Maven
      run: |
          pwd && ls
          whoami
          cd beckn-np-onboarding
          mvn spring-boot:build-image -Dspring-boot.build-image.imageName=ondc-onboard:v0.0
          
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.3.0
      with:
        service_account_key: ${{ secrets.GOOGLE_CREDENTIALS }}
        project_id: grafana-monitoring-demo
        
    - name: Login to GAR
      uses: docker/login-action@v2
      with:
        registry: gcr.io
        username: _json_key
        password: ${{ secrets.GOOGLE_CREDENTIALS }}
        
    - name: Push Docker image
      run: |
          docker images
          docker tag fossgen/ondc-beckn-np-onboarding:2.4.0 asia-south1-docker.pkg.dev/grafana-monitoring-demo/i2-np-onboarding/demo:${{ github.sha }}
          docker images
          docker push asia-south1-docker.pkg.dev/grafana-monitoring-demo/i2-np-onboarding/demo:${{ github.sha }}
          docker images
